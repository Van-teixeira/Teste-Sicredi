(function ($) {
    $.fn.extend({
        leanModal: function (options) {
            var defaults = {
                top: 100,
                overlay: 0.8,
                closeButton: null,
                overlayClose: false,
                onclose: function () { }
            };
            var body = $("form");
            if (body.length == 0) body = $("body");

            if ($("#lean_overlay").length == 0) {
                var style = 'margin:0;padding:0;border:none;width:100%;height:100%;background:#333;opacity:0.6;filter:alpha(opacity=60);z-index:9999;position:fixed;top:0;left:0;';
                var overlay = $("<div id='lean_overlay'></div>");
                overlay.attr("style", style);
                body.eq(0).append(overlay);
            }
            options = $.extend(defaults, options);
            return this.each(function () {
                var o = options;
                var modal_id = $(this);
                if (options.overlayClose) {
                    $("#lean_overlay").click(function () {
                        close_modal(modal_id);
                    });
                }
                $(o.closeButton).click(function () {
                    close_modal(modal_id);
                });
                $(modal_id).appendTo(body);
                var modal_height = $(modal_id).outerHeight();
                var modal_width = $(modal_id).outerWidth();
                var sheight = document.documentElement.clientHeight;
                var swidth = document.documentElement.clientWidth;
                $("#lean_overlay").css({ "display": "block", opacity: 0 });
                $("#lean_overlay").fadeTo(200, o.overlay);
                $(modal_id).css({
                    "display": "block"
                    , "position": "fixed"
                    , "opacity": 0
                    , "z-index": 11000
                    , "left": 50 + "%"
                    , "margin-left": -301 + "px"
                    , "margin-top": -200 + "px"
                    , "top": 50 + "%"
                });
                $(modal_id).fadeTo(200, 1);
            });

            function close_modal(modal_id) {
                $("#lean_overlay").fadeOut(200);
                $(modal_id).css({ "display": "none" });
                if (options.onclose) options.onclose(modal_id);
            }
        }
    })
})(jQuery);